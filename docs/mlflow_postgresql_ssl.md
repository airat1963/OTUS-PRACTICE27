# Настройка MLflow с защищенным соединением PostgreSQL

В этом документе описан процесс настройки MLflow с использованием защищенного SSL-соединения для подключения к кластеру PostgreSQL в Yandex Cloud.

## 1. Общий обзор

MLflow-сервер настроен для работы под обычным пользователем Ubuntu без использования Nginx, что упрощает установку и обслуживание. Соединение с базой данных PostgreSQL защищено с использованием SSL-сертификатов.

## 2. Компоненты инфраструктуры

1. **MLflow сервер**:
   - Запускается как пользовательская служба systemd
   - Работает под обычным пользователем Ubuntu
   - Доступен через порт 5000 напрямую (без прокси)

2. **PostgreSQL кластер**:
   - Managed PostgreSQL в Yandex Cloud
   - SSL-соединение с проверкой сертификата
   - Хранит метаданные MLflow (эксперименты, запуски, модели)

3. **S3-хранилище**:
   - Используется для хранения артефактов MLflow

## 3. Настройка SSL для PostgreSQL

### 3.1. Загрузка корневого сертификата

Для подключения к кластеру PostgreSQL в Yandex Cloud требуется корневой сертификат, который загружается в домашний каталог пользователя:

```bash
mkdir -p ~/.postgresql && \
wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" \
    --output-document ~/.postgresql/root.crt && \
chmod 0600 ~/.postgresql/root.crt
```

### 3.2. Настройка параметров подключения

В конфигурационном файле MLflow настроены следующие параметры для SSL-соединения:

```
MLFLOW_BACKEND_STORE_URI=postgresql://user:password@host:port/dbname?sslmode=verify-full
PGSSLROOTCERT=~/.postgresql/root.crt
PGSSLMODE=verify-full
```

Эти параметры обеспечивают:
- Проверку сертификата сервера PostgreSQL
- Использование корневого сертификата для проверки
- Защищенное соединение с базой данных

## 4. Процесс установки

Установка MLflow автоматизирована с помощью скрипта `setup_mlflow.sh`, который выполняет следующие действия:

1. Обновление пакетов системы
2. Установка необходимых зависимостей
3. Создание виртуального окружения Python
4. Установка MLflow и зависимостей
5. Загрузка сертификата PostgreSQL
6. Настройка конфигурационного файла
7. Создание и запуск пользовательской службы systemd

## 5. Запуск и управление

### 5.1. Запуск службы

MLflow запускается как пользовательская служба systemd:

```bash
systemctl --user start mlflow.service
```

### 5.2. Проверка статуса

```bash
systemctl --user status mlflow.service
```

### 5.3. Просмотр логов

```bash
journalctl --user -u mlflow.service
```

## 6. Подключение к MLflow серверу

MLflow сервер доступен по адресу:

```
http://<ip-адрес-сервера>:5000
```

## 7. Особенности эксплуатации

1. **SSL-соединение** - все соединения с PostgreSQL защищены с использованием SSL
2. **Пользовательская служба** - MLflow запускается как пользовательская служба, что повышает безопасность
3. **Автозапуск** - служба настроена на автоматический запуск при загрузке системы
4. **Простота обслуживания** - отсутствие Nginx упрощает настройку и обслуживание

## 8. Возможные проблемы и их решения

### 8.1. Проблемы с SSL-подключением
- **Причина**: Неправильный путь к корневому сертификату или неверный режим SSL
- **Решение**: Проверьте параметры PGSSLROOTCERT и PGSSLMODE в конфигурационном файле

### 8.2. Служба не запускается
- **Причина**: Ошибки в конфигурации или отсутствие необходимых разрешений
- **Решение**: Проверьте журналы с помощью `journalctl --user -u mlflow.service`

### 8.3. Служба не запускается при загрузке
- **Причина**: Не включен "linger" для пользователя
- **Решение**: Выполните `sudo loginctl enable-linger $USER` 